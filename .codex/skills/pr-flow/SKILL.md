---
name: pr-flow
description: push後にPR作成/表示、@codex・CodeRabbitレビュー依頼、CIとレビュー出力を120秒毎にポーリング監視（上限なし）。双方のレビュー完了後に指摘内容を統一フォーマットで整理して提示し、修正要否を確認。必要に応じて修正→verify→push→再レビュー/CI を繰り返し、条件を満たせば自動マージまで完結。
---

# PR Flow

## 目的

- `git push` 後の「PR作成/取得 → レビュー起動 → CI監視 → レビュー監視 → 指摘整理 → 修正要否確認 →（必要に応じて）修正ループ → 自動マージ」までを、GitHub Web UI に依存せずに完結させる。
- Codex と CodeRabbit（行コメント/レビュー）の**両方が完了**するまで監視し続ける（120秒間隔・上限なし）。
- 指摘を統一フォーマットで提示し、ユーザーに「どれを直すか」を選ばせる。
- P0 は必須修正。P1/P2 はユーザー判断。

## いつ使うか

- `git push` 直後に、PR作成からマージまでを一気通貫で進めたいとき。
- PR は既にあるが、CI/レビュー完了を待って整理・判断・修正まで回したいとき。
- CIやレビューが未開始でも、開始されるまで含めて監視し続けたいとき。

## 前提条件（満たせない場合は「停止＋不足条件の提示」）

- 作業ブランチ上（`main` / `master` 直上で実行しない）。
- `gh auth status` が成功する。
- `jq` が利用可能。

## 入力（暗黙）

- 現在のブランチ（`git rev-parse --abbrev-ref HEAD`）
- 現在のHEAD（`git rev-parse HEAD`）
- 対象PR（存在すればそれ、無ければ作成）

## 出力（ユーザーに提示するもの）

- PR URL / 番号 / base / head / 最新SHA
- CIサマリー（成功/失敗/未開始、失敗時は失敗チェック一覧とリンク）
- レビュー完了判定（Codex/CodeRabbitそれぞれの最新レビュー出力の有無）
- 指摘一覧（統一フォーマット）
- 「修正対応する指摘事項を教えてください」の質問
- 収束後の自動マージ結果（または `AUTO_MERGE=0` の場合はコマンド提示）

## 環境変数

- `BASE_BRANCH`: PRのベースブランチ（既定 `main`）
- `POLL_SEC_REVIEW`: ポーリング間隔（既定 `120`）
- `AUTO_MERGE`: 収束後に自動マージするか（既定 `1`。`0` の場合はコマンド提示のみ）
- `REVIEW_SINCE`: レビュー開始時刻の下限（ISO8601等）。未指定なら「このフロー開始以降」を基準にする

## ガードレール（全工程で常に優先）

- 無関係な整形/リファクタは禁止（差分最小）。
- 禁止領域に触れる必要が出たら停止し、理由と必要な人手判断を提示する。
  - `.github/**`（特に workflows）
  - `.coderabbit.yaml` / `.coderabbit.yml`
  - 依存・ロック系（例: `package.json`, `pnpm-lock.yaml`, `yarn.lock`, `pyproject.toml`, `poetry.lock`, `requirements*.txt`）
  - `.env*` 等の環境変数ファイル

## 実行フロー（状態機械）

以下を順に実行し、条件未達なら同ステップをポーリングで継続する。

### Step 0: 事前チェック

- ブランチが `main/master` なら停止して「作業ブランチへ切替」を指示。
- `gh auth status` / `jq` を確認し、不足があれば停止して導入手順を提示。

### Step 1: PR を「取得または作成」

- 既存PRがあればそれを採用。
- 無ければ `BASE_BRANCH` を base として新規作成。
- 以降は PR 番号/URL を固定して追跡する。

### Step 2: レビュー依頼を投稿（Codex / CodeRabbit）

- PR へコメントを投稿してレビューを起動する（運用に合わせて文言は最小）。
- この時点の時刻を `REVIEW_SINCE`（内部基準）として記録し、「今回フローでのレビュー出力」を判定する下限に使う。

### Step 3: CI 監視（120秒ポーリング・上限なし）

- `gh pr checks` 等で状態を取得し、以下に分類する。
  - `success`: すべて成功
  - `fail`: 失敗が1つ以上
  - `pending`: 実行中/未開始/待ち
- `fail` の場合は「失敗チェック名・URL」を列挙する（可能なら直近ログも要約して添付）。
  - ログ要約は秘密情報/PII を必ずマスキングし、フルログの貼り付けは禁止。
  - 例: `token=***` / `email=***` のように最小限で伏せる。
- `pending` の場合は 120 秒待って再取得（上限なし）。
- `success` になったら Step 4 へ。

### Step 4: レビュー監視（120秒ポーリング・上限なし）

- Codex と CodeRabbit の**双方**について「今回基準（REVIEW_SINCE以降）でのレビュー出力が揃ったか」を判定する。
- 判定対象（いずれも PR 上の出力を収集）:
  - Codex: PRコメント（またはレビューサマリー相当）
  - CodeRabbit: 行コメント（review comments）
- 片方でも未完了なら 120 秒待って再取得（上限なし）。
- 両方完了したら Step 5 へ。

### Step 5: 指摘の抽出・正規化・重複統合

- 入力ソースを統合して「指摘（Finding）」として正規化する。
  - 同一内容の重複（同エージェント/近い文言/同箇所）は統合し、URLは併記する。

### Step 6: 懸念レベル（P0/P1/P2）分類

- Codex:
  - 本文先頭に `P0/P1/P2` がある場合はそれを採用。
  - 無い場合は内容から推定し、重大（壊れる/セキュリティ/データ破壊/テスト失敗誘発）はP0、改善提案はP1、軽微はP2。
- CodeRabbit:
  - "Potential issue" 系の severity を優先して写像する。
    - Critical → P0
    - Major → P1
    - Minor/Trivial/Info → P2
  - それ以外はP2（ただしビルド破壊/明確なバグはP0へ引き上げ可）

### Step 7: 指摘一覧の提示（統一フォーマット）

- 表ではなく、指摘ごとに以下の形式で列挙する（No. は通し番号）。

```text
- No.:
- 懸念レベル: P0|P1|P2
- レビュータイトル: （短い要約。無ければ自動生成）
- レビュー内容: （要点。必要なら箇条書き）
- 参照: file:line / URL（あれば）
- 見解: （あなたの見解）
```

### Step 8: ユーザーに修正対象を確認

- 以下を必ず提示して入力を待つ。

```text
修正対応する指摘事項を教えてください。

対応方法:
- P0 はデフォルトで修正対象です。
- P1/P2 で対応するものがあれば No. を指定してください（例: 2,5）。
```

- ユーザー入力の解釈:
  - `対応なし` かつ P0=0件 → Step 10（自動マージ）
  - それ以外 → Step 9（修正ループ）

### Step 9: 修正ループ（上限なし）

- 対象: P0 全件 + ユーザー指定 No.

- ループの基本形:
  1. 対象指摘に対して最小差分で修正
  2. ガードレール検査（許可範囲外/禁止領域変更があれば停止）
  3. `$verify-fast` を成功させる（成功するまでローカルで修正を続ける）
  4. commit→ push
  5. Step 2（再レビュー依頼）→ Step 3（CI）→ Step 4（レビュー）へ戻す
  6. 新しい指摘が出たら Step 5 以降を再実行し、再度ユーザー判断を取る

- 収束判定:
  - CI: success
  - P0: 0件
  - ユーザー指定の P1/P2: 0件（または対応済み）
  - 満たせば Step 10 へ

### Step 10: 自動マージ

- 条件（全て満たす）:
  - CI が success
  - P0 が 0件
  - 対応指定が残っていない

- `AUTO_MERGE=1` の場合:
  - `gh pr merge --auto --squash --delete-branch` を実行

- `AUTO_MERGE=0` の場合:
  - 上記コマンドを提示して終了

## 例外処理（必ず守る）

- `gh` が一時的に失敗（API揺れ/ネットワーク）:
  - エラー内容を短く表示し、同ステップを再試行（ポーリングに合流）。

- CI が長時間 `pending`:
  - 120秒ごとに継続監視（上限なし）。ユーザー確認なしで続行。

- ガードレール違反が必要になった:
  - commit/push せず停止。変更が必要な理由・該当ファイル・代替案を提示し、ユーザー判断を仰ぐ。
